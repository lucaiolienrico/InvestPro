<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InvestPro | Analisi Immobiliare</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Firebase (client-side) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js" defer></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <style>
    :root {
      --bg-body:#0f172a;
      --bg-card:#1e293b;
      --bg-input:#020617;
      --primary:#10b981;
      --danger:#ef4444;
      --text-main:#f8fafc;
      --text-muted:#94a3b8;
      --border:#334155;
      --radius:8px;
    }

    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:'Inter',sans-serif;
      background:var(--bg-body);
      color:var(--text-main);
      min-height:100vh;
    }

    header {
      position:sticky;
      top:0;
      z-index:50;
      background:rgba(15,23,42,.95);
      border-bottom:1px solid var(--border);
      padding:1rem 1.5rem;
    }

    .nav-container {
      max-width:1400px;
      margin:auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .logo {
      font-weight:700;
      font-size:1.25rem;
      color:var(--primary);
      display:flex;
      gap:.5rem;
      align-items:center;
    }

    .btn {
      cursor:pointer;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:var(--bg-card);
      color:white;
      padding:.5rem 1rem;
      font-weight:600;
    }

    .btn-primary {
      background:var(--primary);
      color:black;
      border-color:var(--primary);
    }

    .hidden { display:none !important; }

    main {
      max-width:1400px;
      margin:auto;
      padding:2rem 1rem;
    }

    .dashboard-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(380px,1fr));
      gap:2rem;
    }

    .card {
      background:var(--bg-card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1.5rem;
    }

    label {
      font-size:.75rem;
      color:var(--text-muted);
      text-transform:uppercase;
      font-weight:600;
    }

    input {
      width:100%;
      padding:.75rem;
      background:var(--bg-input);
      border:1px solid var(--border);
      color:white;
      border-radius:6px;
    }

    input.invalid {
      border-color:var(--danger);
    }

    .kpi {
      display:flex;
      justify-content:space-between;
      margin-top:1rem;
      padding:.75rem;
      background:#020617;
      border-radius:6px;
      border:1px solid var(--border);
    }

    /* Email utente responsive corretto */
    #user-email-display { display:none; font-size:.85rem; }
    @media (min-width:768px){
      #user-email-display { display:inline; }
    }

    /* Modal accessibile */
    .modal {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
    }
    .modal.active {
      opacity:1;
      pointer-events:auto;
    }
    .modal-panel {
      background:var(--bg-card);
      padding:2rem;
      border-radius:12px;
      max-width:500px;
      width:90%;
    }
  </style>
</head>

<body>

<header>
  <div class="nav-container">
    <div class="logo">
      <i class="fa-solid fa-building-columns"></i> InvestPro
    </div>
    <div>
      <span id="user-email-display"></span>
      <button id="loginBtn" class="btn btn-primary">Accedi</button>
      <button id="logoutBtn" class="btn hidden">Logout</button>
    </div>
  </div>
</header>

<main>
  <div class="dashboard-grid">

    <!-- CONTI -->
    <section class="card">
      <h3>Conto Economico</h3>

      <label>ADR (€)</label>
      <input id="adr" type="number" value="120">

      <label>Occupazione (%)</label>
      <input id="occ" type="number" value="65">

      <label>Costi Fissi Mensili (€)</label>
      <input id="fixed-costs" type="number" value="600">

      <div class="kpi">
        <span>Utile Mensile</span>
        <strong id="res-mol">--</strong>
      </div>

      <canvas id="profitChart" height="220"></canvas>
    </section>

    <!-- CONTATTO GDPR -->
    <section class="card">
      <h3>Contatto</h3>

      <label>Email</label>
      <input id="contact-email" type="email" required>

      <div style="margin-top:1rem;">
        <input type="checkbox" id="contact-consent">
        <label for="contact-consent" style="text-transform:none;">
          Acconsento al trattamento dati (GDPR)
        </label>
      </div>

      <button id="contactSubmit" class="btn btn-primary" style="margin-top:1rem;">
        Invia
      </button>
    </section>

  </div>
</main>

<!-- MODAL LOGIN -->
<div id="loginModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-panel">
    <h2>Login</h2>
    <button id="googleLogin" class="btn btn-primary" style="width:100%;">
      Login Google
    </button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const CONFIG = {
  firebase: {
    apiKey: "AIzaSyDiGDvR2yXm0DE7vlJNGrIPQB0G-ntLHc0",
    authDomain: "analisimmobiliare-3b4a7.firebaseapp.com",
    projectId: "analisimmobiliare-3b4a7"
  }
};

/* ================= INIT ================= */
firebase.initializeApp(CONFIG.firebase);
const auth = firebase.auth();

/* ================= STATE ================= */
const state = { user:null, chart:null };

/* ================= VALIDATION ================= */
const VALIDATION = {
  adr:{min:1,max:10000},
  occ:{min:0,max:100},
  "fixed-costs":{min:0,max:50000}
};

const validateAll = () => {
  let ok=true;
  for(const id in VALIDATION){
    const el=document.getElementById(id);
    const v=parseFloat(el.value);
    const r=VALIDATION[id];
    if(isNaN(v)||v<r.min||v>r.max){
      el.classList.add("invalid");
      ok=false;
    } else el.classList.remove("invalid");
  }
  return ok;
};

/* ================= CALC ================= */
const calc = () => {
  if(!validateAll()) return;
  const adr=+adr.value;
  const occ=+occ.value/100;
  const fixed=+document.getElementById("fixed-costs").value;
  const nights=365*occ;
  const net=(adr*nights - fixed*12)/12;
  document.getElementById("res-mol").textContent =
    net.toLocaleString("it-IT",{style:"currency",currency:"EUR"});
  updateChart(net);
};

/* ================= CHART ================= */
const updateChart = (net) => {
  if(!state.chart){
    const c=document.getElementById("profitChart");
    if(!c) return;
    state.chart=new Chart(c,{
      type:"doughnut",
      data:{labels:["Utile"],datasets:[{data:[net],backgroundColor:["#10b981"]}]},
      options:{responsive:true}
    });
  } else {
    state.chart.data.datasets[0].data=[net];
    state.chart.update();
  }
};

/* ================= AUTH ================= */
auth.onAuthStateChanged(u=>{
  state.user=u;
  document.getElementById("loginBtn").classList.toggle("hidden",!!u);
  document.getElementById("logoutBtn").classList.toggle("hidden",!u);
  document.getElementById("user-email-display").textContent=u?u.email:"";
});

/* ================= EVENTS ================= */
document.getElementById("loginBtn").onclick=()=>loginModal.classList.add("active");
document.getElementById("logoutBtn").onclick=()=>auth.signOut();
document.getElementById("googleLogin").onclick=()=>{
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  loginModal.classList.remove("active");
};

["adr","occ","fixed-costs"].forEach(id=>{
  document.getElementById(id).addEventListener("input",calc);
});

document.getElementById("contactSubmit").onclick=()=>{
  if(!contact-consent.checked){
    alert("Consenso obbligatorio");
    return;
  }
  const payload={
    email:contact-email.value,
    consent:true,
    consentAt:new Date().toISOString()
  };
  console.log("GDPR LOG:",payload);
  alert("Messaggio inviato");
};
</script>

</body>
</html>
